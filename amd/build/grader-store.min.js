define(["local_customgrader/grader-utils","local_customgrader/grader-enums","local_customgrader/grader-service","local_customgrader/vendor-vue","local_customgrader/vendor-lodash"],function(e,t,a,r,d){var s={ADD_GRADE:"addGrade",DELETE_CATEGORY:"deleteCategory",ADD_ITEM:"addItem",ADD_CATEGORY:"addCategory",ADD_GRADE_TO_STUDENT:"addGradeToStudent",SET_STATE:"setAllState",SET_GRADE:"setGrade",SET_GRADES:"setGrades",SET_CATEGORY:"setCategory",SET_STUDENT_SORT_METHOD:"setStudentSortMethod",SET_SELECTED_CATEGORY_ID:"setSelectedCategoryId",SET_LEVELS:"setLevels",SET_ITEM:"setItem",DELETE_ITEM:"deleteItem",DELETE_GRADE:"deleteItemGrades"},l={FETCH_STATE:"fetchAllState",FILL_GRADES:"fillGrades",FILL_GRADES_FOR_NEW_ITEM:"fillGradesForNewItem",UPDATE_GRADE:"updateGrade",DELETE_ITEM:"deleteItem",DELETE_CATEGORY_CHILDS:"deleteCategoryChilds",UPDATE_CATEGORY:"setCategory",ADD_ITEM:"addItem",ADD_PARTIAL_EXAM:"addPartialExam",DELETE_CATEGORY:"deleteCategory",ADD_CATEGORY:"addCategory",UPDATE_ITEM:"setItem",DELETE_ITEM_GRADES:"deleteItemGrades"};return{store:{state:{decimalPlaces:2,additionalColumnsAtFirst:[{text:"CÃ³digo estudiante"},{text:"",hide:!0}],additionalColumnsAtEnd:[{text:"Nota final"}],sortStudentsMethodType:{name:t.sortStudentMethods.LAST_NAME,order:t.sortDirection.ASC},students:{},selectedCategoryId:null,items:{},categories:[],grades:{},levels:[],course:{fullname:"Nombre completo de el curso"},maxDisplayGrade:5,gradeDisplayRange:.5},mutations:{[s.DELETE_ITEM](e,t){r.delete(e.items,t)},[s.DELETE_CATEGORY](e,t){const a=e.categories.map(e=>e.id).indexOf(t);r.delete(e.categories,a)},[s.SET_STUDENT_SORT_METHOD](e,t){e.sortStudentsMethodType=t},[s.DELETE_GRADE](e,t){Object.keys(e.students).forEach(a=>{const d=e.students[a];r.set(e.students[a],"gradeIds",d.gradeIds.filter(e=>e!==t))}),r.delete(e.grades,t)},[s.ADD_ITEM](e,t){r.set(e.items,t.id,t)},[s.ADD_CATEGORY](e,t){e.categories.push(t)},[s.ADD_GRADE](t,a){a.id=e.ID();let d=t.students[a.userid],s=d.gradeIds?d.gradeIds:[];r.set(t.grades,a.id,a),r.set(t.students[d.id],"gradeIds",[...s,a.id])},[s.ADD_GRADE_TO_STUDENT](e,t){let a=t.grade,d=t.studentId,s=e.students[d],i=s.gradeIds?s.gradeIds:[];r.set(e.students[d],"gradeIds",[...i,a.id])},[s.SET_ITEM](e,t){r.set(e.items,t.id,t)},[s.SET_LEVELS](e,t){e.levels=t},[s.SET_CATEGORY](e,t){let a=e.categories.map(e=>e.id).indexOf(t.id);r.set(e.categories,a,t)},[s.SET_GRADES](t,a){a.forEach(a=>{const d=Object.values(t.grades).find(e=>e.itemid===a.itemid&&e.userid===a.userid);if(a.finalgrade=e.removeInsignificantTrailZeros(a.finalgrade),d.finalgrade!=a.finalgrade){if(console.log("nel prro"),!t.grades[a.id]){t.grades[a.id]=a;const e=[...t.students[d.userid].gradeIds.filter(e=>e!==d.id),a.id];t.students[a.userid]={...t.students[a.userid],gradeIds:e},r.delete(t.grades,d.id)}r.set(t.grades,a.id,a)}})},[s.SET_GRADE](t,a){let d=a.old,s=a.new;if(s.finalgrade=e.removeInsignificantTrailZeros(s.finalgrade),t.grades[s.id]=s,d&&d.id!==s.id){const e=[...t.students[d.userid].gradeIds.filter(e=>e!==d.id),s.id];t.students[d.userid]={...t.students[d.userid],gradeIds:e},r.delete(t.grades,d.id)}},[s.SET_SELECTED_CATEGORY_ID](e,t){e.selectedCategoryId=t},[s.SET_STATE](t,a){t.levels=a.levels;let r={};a.students.forEach(e=>{r[e.id]=e}),t.students=r;let d={};a.items.forEach(e=>{d[e.id]=e}),t.items=d,t.categories=a.categories;let s={};a.grades.forEach(t=>{s[t.id]={...t,finalgrade:e.removeInsignificantTrailZeros(t.finalgrade)}}),t.grades=s,t.course=a.course}},actions:{[l.DELETE_ITEM]({commit:e,dispatch:t,state:r},d){a.delete_item(d).then(a=>{e(s.SET_LEVELS,a.levels),e(s.DELETE_ITEM,d),t(l.DELETE_ITEM_GRADES,d)})},[l.ADD_ITEM]({commit:e,dispatch:t},r){a.add_item(r).then(a=>{e(s.ADD_ITEM,a.item),e(s.SET_LEVELS,a.levels),t(l.FILL_GRADES_FOR_NEW_ITEM,a.item)})},[l.DELETE_ITEM_GRADES]({commit:e,state:t},a){let r=Object.keys(t.grades),d=[];r.forEach(e=>{t.grades[e].itemid===a&&d.push(e)}),d.forEach(t=>{e(s.DELETE_GRADE,t)})},[l.ADD_PARTIAL_EXAM]({commit:e,getters:t},r){a.add_partial_exam(r).then(t=>{e(s.SET_LEVELS,t.levels),e(s.ADD_CATEGORY,t.category),e(s.ADD_ITEM,t.partial_item),e(s.ADD_ITEM,t.optional_item)})},[l.DELETE_CATEGORY_CHILDS]({commit:e,getters:t,dispatch:a},r){const d=t.categoryChildItems(r),i=t.categoryChildCategories(r);d.forEach(t=>{e(s.DELETE_ITEM,t.id),a(l.DELETE_ITEM_GRADES,t.id)}),i.forEach(t=>{e(s.DELETE_CATEGORY,t.id)})},[l.DELETE_CATEGORY]({commit:e,getters:t,dispatch:r},d){a.delete_category(d).then(t=>{e(s.SET_LEVELS,t.levels),r(l.DELETE_CATEGORY_CHILDS,d),e(s.DELETE_CATEGORY,d)})},[l.FILL_GRADES_FOR_NEW_ITEM]({commit:e,state:t,getters:a},r){Object.keys(t.students).forEach(t=>{let a={userid:t,itemid:r.id,finalgrade:null,rawgrademin:r.grademin,rawgrademax:r.grademax};e(s.ADD_GRADE,a)})},[l.FILL_GRADES]({commit:e,state:t,getters:a}){let r=Object.keys(t.students),d=Object.values(t.grades);r.forEach(r=>{for(var i of a.itemOrderIds){let a=t.items[i],l=d.find(e=>e.userid===r&&e.itemid===a.id);if(l)e(s.ADD_GRADE_TO_STUDENT,{studentId:r,grade:l});else{let t={userid:r,itemid:a.id,finalgrade:null,rawgrademin:a.grademin,rawgrademax:a.grademax};e(s.ADD_GRADE,t)}}})},[l.UPDATE_GRADE]({commit:e,state:t},r){a.update_grade(r,t.course.id).then(t=>{console.log(t),e(s.SET_GRADES,t.other_grades)})},[l.UPDATE_CATEGORY]({dispatch:e,commit:t},r){a.update_category(r).then(e=>{let a=e.category,r=e.levels;t(s.SET_CATEGORY,a),t(s.SET_LEVELS,r)})},[l.ADD_CATEGORY]({commit:e,state:t,dispatch:r},d){a.add_category(d.category,d.weight).then(t=>{let a=t.category,d=t.category_item,i=t.levels;e(s.ADD_ITEM,d),e(s.ADD_CATEGORY,a),e(s.SET_LEVELS,i),r(l.FILL_GRADES_FOR_NEW_ITEM,d)})},[l.UPDATE_ITEM]({dispatch:e,commit:t},r){a.update_item(r).then(e=>{let a=e.item,r=e.levels;t(s.SET_ITEM,a),t(s.SET_LEVELS,r),t(s.SET_GRADES,e.other_grades)})},[l.FETCH_STATE]({dispatch:t,commit:r}){a.get_grader_data(e.getCourseId()).then(e=>{r(s.SET_STATE,e),t(l.FILL_GRADES)})}},getters:{courseLevel:e=>e.levels[0]?e.levels[0][0]:[],selectedCategory:(e,t)=>t.categoryById(e.selectedCategoryId),itemLevel:e=>e.levels[e.levels.length-1],categoryLevels:e=>{let t=e.levels.slice(1,e.levels.length-1);return t||[]},itemsCount:e=>Object.keys(e.items).length,categoryById:e=>t=>e.categories.find(e=>e.id===t),studentById:e=>t=>e.students[t],studentSetSorted:(e,a)=>(function(e,a){switch(a.name){case t.sortStudentMethods.FIRST_NAME:return d.orderBy(e,["firstname"],a.order);case t.sortStudentMethods.LAST_NAME:return d.orderBy(e,["lastname"],a.order)}})(a.studentSet,e.sortStudentsMethodType),studentSet:e=>Object.values(e.students),studentsCount:e=>Object.keys(e.students).length,studentsAsesCount:(e,t)=>t.studentSet.filter(e=>e.is_ases).length,itemSet:e=>Object.values(e.items),isWeightHundred:(e,t)=>{let a=t.getCategoryIds;if(!t.categoryWeightsIsHundred(a[0],!0))return!1;for(i=1;i<a.length;i++)if(!t.categoryWeightsIsHundred(a[i]))return!1;return!0},categoryWeightsIsHundred:(e,t)=>(e,a=!1)=>{let r=t.getWeightsByCat(e,a);console.log(r);let d=r.reduce((e,t)=>e+t,0);return console.log(d),0==d||100==d},getWeightsByCat:e=>(t,a=!1)=>{let r=0;return r=a?Object.values(e.items).map(e=>e.categoryid==t||null==e.categoryid?Number(e.aggregationcoef):0):Object.values(e.items).map(e=>e.categoryid==t?Number(e.aggregationcoef):0)},getWeights:(e,t)=>{return Object.values(e.items).map(e=>Number(e.aggregationcoef))},getCategoryIds:e=>{return Object.values(e.categories).map(e=>e.id)},itemOrderIds:(e,t)=>{let a=t.itemLevel;return a?a.map(e=>e.object.id):Object.keys(e.items)},itemOrderedNames:(e,t)=>{let a=t.itemLevel;return a?a.map(e=>null===e.object.itemname||""===e.object.itemname?"Total "+t.categoryById(e.object.iteminstance).fullname:e.object.itemname):Object.keys(e.items)},finalGradeId:(e,t)=>t.itemOrderIds[t.itemOrderIds.length-1],categoryChildItems:(e,t)=>e=>{let a=t.itemSet.filter(t=>t.categoryid===e||t.iteminstance===e);return Array.isArray(a)?a:[]},categoryChildCategories:e=>t=>{let a=e.categories.filter(e=>e.parent===t);return a||[]},categoryChildSize:(e,t)=>e=>{let a=t.categoryChildItems(e),r=t.categoryChildCategories(e);return a.length+r.length},categoryDepth:e=>{if(e.categories.length<=0)return 0;var t=e.categories.map(e=>e.depth);return Math.max.apply(Math,t)},getCategoriesByDepth:e=>t=>e.categories.find(e=>e.depth===t),gradesSet:e=>Object.values(e.grades),gradesByItemId:(e,t)=>e=>t.gradesSet.filter(t=>t.itemid===e),passingGrades:(e,t)=>t.gradesSet.filter(e=>e.finalgrade>=.6*e.rawgrademax),passingGradesSet:(e,t)=>t.itemOrderIds.map(e=>t.gradesByItemId(e).filter(e=>e.finalgrade>=.6*e.rawgrademax).length),failingGrades:(e,t)=>t.gradesSet.filter(e=>e.finalgrade<.6*e.rawgrademax&&null!=e.finalgrade),failingGradesSet:(e,t)=>t.itemOrderIds.map(e=>t.gradesByItemId(e).filter(e=>e.finalgrade<.6*e.rawgrademax&&null!=e.finalgrade).length),nullGrades:(e,t)=>t.gradesSet.filter(e=>null===e.finalgrade||void 0===e.finalgrade),nullGradesSet:(e,t)=>t.itemOrderIds.map(e=>t.gradesByItemId(e).filter(e=>null===e.finalgrade||void 0===e.finalgrade).length),passingGradesCount:(e,t)=>t.passingGrades.length,failingGradesCount:(e,t)=>t.failingGrades.length,nullGradesCount:(e,t)=>t.nullGrades.length,finalGradesSet:(e,t)=>t.gradesSet.filter(e=>e.itemid===t.finalGradeId),finalPassingGradeSet:(e,t)=>t.finalGradesSet.filter(e=>e.finalgrade>=.6*e.rawgrademax),lineGraphLabel:e=>{let t=[],a=e.maxDisplayGrade/e.gradeDisplayRange,r=0,d="";for(i=0;i<a-1;i++)d=r+" - ",d+=(r+=e.gradeDisplayRange)-.1,t.push(d);return d=r+" - "+e.maxDisplayGrade,t.push(d),t},getGradesByRange:(e,t)=>{let a=0,r=e.gradeDisplayRange,d=[],s=e.maxDisplayGrade/e.gradeDisplayRange,l=t.finalGradesSet.map(t=>t.finalgrade/t.rawgrademax*e.maxDisplayGrade);for(i=0;i<s-1;i++)d.push(l.filter(e=>e>=a&&e<r).length),a+=e.gradeDisplayRange,r+=e.gradeDisplayRange;return d.push(l.filter(e=>e>=a).length),d}}},mutations:s,actions:l}});